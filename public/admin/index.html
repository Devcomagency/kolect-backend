<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KOLECT Admin V2.1 - Backoffice Complet + Matching System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .admin-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section h1 {
            color: #4ECDC4;
            font-size: 28px;
            font-weight: 700;
        }

        .logo-section p {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            background: #4ECDC4;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .logout-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }

        /* Navigation Tabs */
        .admin-tabs {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .tab-nav {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: transparent;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            color: #666;
            font-size: 14px;
        }

        .tab-btn.active {
            background: #4ECDC4;
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background: rgba(78, 205, 196, 0.1);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #4ECDC4;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-growth {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 20px;
            font-weight: 500;
        }

        .growth-positive {
            background: rgba(46, 204, 113, 0.1);
            color: #2ecc71;
        }

        .growth-negative {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        /* Charts */
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Tables */
        .data-table {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
            margin-bottom: 25px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th,
        .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .table th {
            background: rgba(78, 205, 196, 0.1);
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }

        .table tr:hover {
            background: rgba(78, 205, 196, 0.05);
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: #4ECDC4;
            color: white;
        }

        .btn-primary:hover {
            background: #35A085;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* Initiatives */
        .initiative-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .initiative-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .initiative-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .initiative-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-active {
            background: rgba(46, 204, 113, 0.1);
            color: #2ecc71;
        }

        .status-inactive {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ECDC4, #35A085);
            transition: width 0.3s;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        .close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #4ECDC4;
        }

        /* Filters */
        .filters {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        /* Status badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-pending {
            background: rgba(243, 156, 18, 0.1);
            color: #f39c12;
        }

        .status-approved {
            background: rgba(46, 204, 113, 0.1);
            color: #2ecc71;
        }

        .status-rejected {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        /* Loading & Error */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .success {
            background: rgba(46, 204, 113, 0.1);
            color: #2ecc71;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        /* MATCHING SYSTEM STYLES */
        .section-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            color: white;
        }

        .section-header h2 {
            margin-bottom: 10px;
            color: #4ECDC4;
        }

        .matching-subnav {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .subnav-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .subnav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .subnav-btn.active {
            background: #4ECDC4;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }

        .matching-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .matching-section.active {
            display: block;
        }

        /* Upload Zone */
        .upload-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .upload-zone {
            border: 3px dashed rgba(255, 255, 255, 0.4);
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-zone:hover {
            border-color: #4ECDC4;
            background: rgba(78, 205, 196, 0.1);
        }

        .upload-zone.dragover {
            border-color: #4ECDC4;
            background: rgba(78, 205, 196, 0.2);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .upload-zone h3 {
            color: white;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .upload-zone p {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 20px;
        }

        /* Progress Bar pour matching */
        .upload-progress {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .upload-progress .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .upload-progress .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ECDC4, #44A08D);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            color: white;
            font-weight: bold;
        }

        /* Results */
        .upload-results {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .result-stat {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
        }

        .result-stat .stat-number {
            display: block;
            font-size: 32px;
            font-weight: bold;
            color: #4ECDC4;
            margin-bottom: 5px;
        }

        .result-stat .stat-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        /* Pending Matches */
        .pending-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: white;
        }

        .pending-matches {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
        }

        .match-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #4ECDC4;
            color: white;
        }

        .match-candidates {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .candidate {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .candidate:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .candidate.selected {
            background: rgba(78, 205, 196, 0.3);
            border: 2px solid #4ECDC4;
        }

        /* Config */
        .config-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .config-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .config-section h4 {
            color: #4ECDC4;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .config-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            color: white;
        }

        .config-item label {
            flex: 1;
            margin-right: 20px;
        }

        .config-item input[type="range"] {
            flex: 2;
            margin-right: 15px;
        }

        .config-item input[type="number"] {
            width: 80px;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            text-align: center;
        }

        /* Chart Container pour matching */
        .chart-container.matching {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            height: 400px;
        }

        /* Activity List */
        .activity-list {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .recent-activity {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .recent-activity h4 {
            color: white;
            margin-bottom: 15px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.8);
            font-style: italic;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-container {
                padding: 15px;
            }

            .admin-header {
                flex-direction: column;
                gap: 15px;
            }

            .tab-nav {
                flex-wrap: wrap;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .matching-subnav {
                flex-direction: column;
            }
            
            .results-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .match-candidates {
                grid-template-columns: 1fr;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="admin-container">
        <div style="max-width: 400px; margin: 100px auto;">
            <div class="stat-card">
                <h1 style="text-align: center; color: #4ECDC4; margin-bottom: 30px;">
                    üè¢ KOLECT Admin V2.1
                </h1>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="loginEmail" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mot de passe</label>
                        <input type="password" id="loginPassword" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px;">
                        Se connecter
                    </button>
                </form>
                <div id="loginError" class="error" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Main Admin Interface -->
    <div id="mainInterface" class="admin-container" style="display: none;">
        <!-- Header -->
        <div class="admin-header">
            <div class="logo-section">
                <h1>üè¢ KOLECT Admin V2.1</h1>
                <p>Backoffice de gestion complet + Matching System</p>
            </div>
            <div class="admin-info">
                <div class="admin-avatar" id="adminAvatar">A</div>
                <div>
                    <div style="font-weight: 600;" id="adminName">Admin</div>
                    <div style="font-size: 12px; color: #666;">Administrateur</div>
                </div>
                <button class="logout-btn" onclick="logout()">D√©connexion</button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="admin-tabs">
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
                <button class="tab-btn" onclick="switchTab('collaborators')">üë• Collaborateurs</button>
                <button class="tab-btn" onclick="switchTab('initiatives')">üéØ Initiatives</button>
                <button class="tab-btn" onclick="switchTab('verifications')">‚úÖ V√©rifications</button>
                <button class="tab-btn" onclick="switchTab('activity')">üìà Activit√©</button>
                <button class="tab-btn" onclick="switchTab('matching')">ü§ñ Matching System</button>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid" id="statsGrid">
                <div class="loading">Chargement des statistiques...</div>
            </div>

            <div class="chart-container">
                <div class="chart-title">üìà √âvolution des signatures (30 derniers jours)</div>
                <canvas id="signaturesChart" width="400" height="100"></canvas>
            </div>

            <div class="data-table">
                <div class="chart-title">üéØ Performance par initiative</div>
                <div id="initiativesPerformance">
                    <div class="loading">Chargement...</div>
                </div>
            </div>
        </div>

        <!-- Collaborators Tab -->
        <div id="collaborators" class="tab-content">
            <div class="chart-title">
                üë• Gestion des collaborateurs
                <button class="btn btn-primary" onclick="showCollaboratorStats()">üìä Stats</button>
            </div>
            
            <div class="data-table">
                <table class="table" id="collaboratorsTable">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Email</th>
                            <th>Statut</th>
                            <th>Scans</th>
                            <th>Signatures</th>
                            <th>Qualit√©</th>
                            <th>Dernier scan</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="8" class="loading">Chargement des collaborateurs...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Initiatives Tab -->
        <div id="initiatives" class="tab-content">
            <div class="chart-title">
                üéØ Gestion des initiatives
                <button class="btn btn-primary" onclick="showCreateInitiativeModal()">‚ûï Nouvelle initiative</button>
            </div>
            <div id="initiativesList">
                <div class="loading">Chargement des initiatives...</div>
            </div>
        </div>

        <!-- Verifications Tab -->
        <div id="verifications" class="tab-content">
            <div class="chart-title">
                ‚úÖ V√©rifications manuelles
                <div>
                    <button class="btn btn-success" onclick="loadVerificationStats()">üìä Stats</button>
                    <button class="btn btn-primary" onclick="loadPendingVerifications()">üîÑ Actualiser</button>
                </div>
            </div>

            <div class="filters">
                <div class="filters-grid">
                    <div class="form-group">
                        <label class="form-label">Type de probl√®me</label>
                        <select id="doubtReasonFilter" class="form-control" onchange="loadPendingVerifications()">
                            <option value="all">Tous les probl√®mes</option>
                            <option value="low_confidence">Confiance faible</option>
                            <option value="too_many_signatures">Trop de signatures</option>
                            <option value="poor_quality">Qualit√© faible</option>
                            <option value="too_few_signatures">Peu de signatures</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Actions en lot</label>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="bulkApprove()">‚úÖ Approuver s√©lection</button>
                            <button class="btn btn-danger" onclick="bulkReject()">‚ùå Rejeter s√©lection</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="data-table">
                <table class="table" id="verificationsTable">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllVerifications" onchange="toggleSelectAll()"></th>
                            <th>Collaborateur</th>
                            <th>Initiative</th>
                            <th>Signatures</th>
                            <th>Probl√®me</th>
                            <th>Qualit√©</th>
                            <th>Confiance</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="9" class="loading">Chargement des v√©rifications...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Activity Tab -->
        <div id="activity" class="tab-content">
            <div class="chart-title">üìà Activit√© d√©taill√©e</div>
            
            <div class="filters">
                <div class="filters-grid">
                    <div class="form-group">
                        <label class="form-label">Collaborateur</label>
                        <select id="activityCollaboratorFilter" class="form-control">
                            <option value="all">Tous les collaborateurs</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Initiative</label>
                        <select id="activityInitiativeFilter" class="form-control">
                            <option value="all">Toutes les initiatives</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date d√©but</label>
                        <input type="date" id="activityDateFrom" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date fin</label>
                        <input type="date" id="activityDateTo" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Grouper par</label>
                        <select id="activityGroupBy" class="form-control">
                            <option value="day">Jour</option>
                            <option value="week">Semaine</option>
                            <option value="month">Mois</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="loadActivityDetailed()" style="width: 100%;">
                            üîç Filtrer
                        </button>
                    </div>
                </div>
            </div>

            <div class="stats-grid" id="activityStats">
                <div class="loading">Appliquez des filtres pour voir l'activit√©</div>
            </div>

            <div class="data-table">
                <table class="table" id="activityTable">
                    <thead>
                        <tr>
                            <th>P√©riode</th>
                            <th>Collaborateur</th>
                            <th>Initiative</th>
                            <th>Scans</th>
                            <th>Signatures</th>
                            <th>Qualit√© moy.</th>
                            <th>Fiabilit√©</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="7" class="loading">Utilisez les filtres pour charger l'activit√©</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- MATCHING SYSTEM TAB -->
        <div id="matching" class="tab-content">
            <div class="section-header">
                <h2>ü§ñ Matching System - Phase 1</h2>
                <p>Automation validation feuilles terrain ‚Üî chancelerie</p>
            </div>

            <!-- Matching Sub-Navigation -->
            <div class="matching-subnav">
                <button class="subnav-btn active" onclick="switchMatchingTab('upload')">üì§ Upload Batch</button>
                <button class="subnav-btn" onclick="switchMatchingTab('pending')">üéØ Matches Pending</button>
                <button class="subnav-btn" onclick="switchMatchingTab('dashboard')">üìä Dashboard</button>
                <button class="subnav-btn" onclick="switchMatchingTab('config')">‚öôÔ∏è Configuration</button>
            </div>

            <!-- Upload Batch Section -->
            <div id="matching-upload" class="matching-section active">
                <div class="upload-container">
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">üìÅ</div>
                        <h3>Upload Batch Validation</h3>
                        <p>Glissez jusqu'√† 1000 feuilles de validation ici</p>
                        <button class="btn-primary" onclick="triggerFileInput()">S√©lectionner Fichiers</button>
                        <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
                    </div>
                    
                    <!-- Progress Section -->
                    <div id="uploadProgress" class="upload-progress" style="display: none;">
                        <h4 style="color: white;">Traitement en cours...</h4>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-stats">
                            <span id="progressText">0/0 fichiers trait√©s</span>
                            <span id="progressPercent">0%</span>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div id="uploadResults" class="upload-results" style="display: none;">
                        <h4 style="color: white;">R√©sultats Matching</h4>
                        <div class="results-summary">
                            <div class="result-stat">
                                <span class="stat-number" id="totalProcessed">0</span>
                                <span class="stat-label">Fichiers trait√©s</span>
                            </div>
                            <div class="result-stat">
                                <span class="stat-number" id="autoMatched">0</span>
                                <span class="stat-label">Matches automatiques</span>
                            </div>
                            <div class="result-stat">
                                <span class="stat-number" id="pendingReview">0</span>
                                <span class="stat-label">En attente validation</span>
                            </div>
                            <div class="result-stat">
                                <span class="stat-number" id="errorCount">0</span>
                                <span class="stat-label">Erreurs</span>
                            </div>
                        </div>
                        <div id="resultsDetails" class="results-details"></div>
                    </div>
                </div>
            </div>

            <!-- Pending Matches Section -->
            <div id="matching-pending" class="matching-section">
                <div class="pending-header">
                    <h3>üéØ Matches en Attente de Validation Manuelle</h3>
                    <button class="btn btn-secondary" onclick="refreshPendingMatches()">üîÑ Actualiser</button>
                </div>
                <div id="pendingMatchesList" class="pending-matches">
                    <div class="loading">Chargement des matches en attente...</div>
                </div>
            </div>

            <!-- Matching Dashboard Section -->
            <div id="matching-dashboard" class="matching-section">
                <div class="matching-stats">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">ü§ñ</div>
                            <div class="stat-number" id="totalMatches">0</div>
                            <div class="stat-label">Total Matches</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">‚úÖ</div>
                            <div class="stat-number" id="autoSuccessRate">0%</div>
                            <div class="stat-label">Taux Auto-Match</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">‚è±Ô∏è</div>
                            <div class="stat-number" id="avgProcessTime">0s</div>
                            <div class="stat-label">Temps Moyen</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üìä</div>
                            <div class="stat-number" id="confidenceAvg">0%</div>
                            <div class="stat-label">Confiance Moyenne</div>
                        </div>
                    </div>
                </div>

                <!-- Chart Container -->
                <div class="chart-container matching">
                    <canvas id="matchingChart"></canvas>
                </div>

                <!-- Recent Activity -->
                <div class="recent-activity">
                    <h4>üïí Activit√© R√©cente Matching</h4>
                    <div id="recentMatchingActivity" class="activity-list">
                        <div class="loading">Chargement activit√©...</div>
                    </div>
                </div>
            </div>

            <!-- Configuration Section -->
            <div id="matching-config" class="matching-section">
                <div class="config-container">
                    <h3 style="color: white;">‚öôÔ∏è Configuration Matching System</h3>
                    
                    <div class="config-section">
                        <h4>Seuils de Confiance</h4>
                        <div class="config-item">
                            <label>Seuil Auto-Match (‚â•90%)</label>
                            <input type="range" id="autoThreshold" min="80" max="100" value="90">
                            <span id="autoThresholdValue">90%</span>
                        </div>
                        <div class="config-item">
                            <label>Seuil Validation Manuelle (70-89%)</label>
                            <input type="range" id="manualThreshold" min="60" max="80" value="70">
                            <span id="manualThresholdValue">70%</span>
                        </div>
                    </div>

                    <div class="config-section">
                        <h4>Param√®tres Matching</h4>
                        <div class="config-item">
                            <label>Fen√™tre temporelle (jours)</label>
                            <input type="number" id="timeWindow" value="30" min="1" max="90">
                        </div>
                        <div class="config-item">
                            <label>Tol√©rance signatures</label>
                            <input type="number" id="signatureTolerance" value="2" min="0" max="5">
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="saveMatchingConfig()">üíæ Sauvegarder Configuration</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Collaborator Details Modal -->
    <div id="collaboratorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">D√©tails collaborateur</h2>
                <button class="close" onclick="closeModal('collaboratorModal')">&times;</button>
            </div>
            <div id="collaboratorDetails">
                <div class="loading">Chargement...</div>
            </div>
        </div>
    </div>

    <!-- Create Initiative Modal -->
    <div id="createInitiativeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Nouvelle initiative</h2>
                <button class="close" onclick="closeModal('createInitiativeModal')">&times;</button>
            </div>
            <form id="createInitiativeForm">
                <div class="form-group">
                    <label class="form-label">Nom *</label>
                    <input type="text" id="initiativeName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="initiativeDescription" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Objectif signatures</label>
                    <input type="number" id="initiativeTarget" class="form-control" value="1000">
                </div>
                <div class="form-group">
                    <label class="form-label">√âch√©ance</label>
                    <input type="date" id="initiativeDeadline" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Instructions GPT-4</label>
                    <textarea id="initiativeGptInstructions" class="form-control" rows="3"
                        placeholder="Instructions sp√©cifiques pour la d√©tection automatique"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Couleur th√®me</label>
                    <input type="color" id="initiativeThemeColor" class="form-control" value="#4ECDC4">
                </div>
                <div style="display: flex; gap: 15px; justify-content: flex-end;">
                    <button type="button" class="btn btn-danger" onclick="closeModal('createInitiativeModal')">
                        Annuler
                    </button>
                    <button type="submit" class="btn btn-success">
                        Cr√©er l'initiative
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Verification Modal -->
    <div id="verificationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">V√©rification manuelle</h2>
                <button class="close" onclick="closeModal('verificationModal')">&times;</button>
            </div>
            <div id="verificationContent">
                <div class="loading">Chargement...</div>
            </div>
        </div>
    </div>

    <script>
        let adminData = null;
        let signaturesChart = null;
        let matchingChart = null;
        let selectedVerifications = new Set();

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            setupMatchingEventListeners();
        });

        // Authentification
        async function checkAuth() {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                showLoginScreen();
                return;
            }

            try {
                const response = await fetch('/api/admin/auth/verify', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Token invalide');

                const data = await response.json();
                adminData = data.admin;
                
                showMainInterface();
                loadDashboard();
            } catch (error) {
                localStorage.removeItem('adminToken');
                showLoginScreen();
            }
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainInterface').style.display = 'none';
        }

        function showMainInterface() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainInterface').style.display = 'block';
            
            document.getElementById('adminName').textContent = adminData.name;
            document.getElementById('adminAvatar').textContent = adminData.name[0].toUpperCase();
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const response = await fetch('/api/admin/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Erreur de connexion');
                }

                localStorage.setItem('adminToken', data.token);
                adminData = data.admin;
                
                showMainInterface();
                loadDashboard();

            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            }
        });

        // Dashboard
        async function loadDashboard() {
            try {
                const token = localStorage.getItem('adminToken');
                
                // Stats principales
                const statsResponse = await fetch('/api/admin/dashboard/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!statsResponse.ok) throw new Error('Erreur stats');
                const stats = await statsResponse.json();
                
                displayStats(stats);
                displayInitiativesPerformance(stats.realInitiatives || []);
                
                // Activit√© r√©cente
                const activityResponse = await fetch('/api/admin/dashboard/recent-activity', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (activityResponse.ok) {
                    const activity = await activityResponse.json();
                    // Stocker pour usage ult√©rieur
                    window.recentActivity = activity;
                }

                // Charger collaborateurs
                loadCollaborators();
                loadInitiatives();

            } catch (error) {
                console.error('Erreur chargement:', error);
                document.getElementById('statsGrid').innerHTML = `
                    <div class="error">Erreur de chargement: ${error.message}</div>
                `;
            }
        }

        function displayStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            const growthClass = stats.growthPercent >= 0 ? 'growth-positive' : 'growth-negative';
            const growthIcon = stats.growthPercent >= 0 ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è';

            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">üìù</div>
                    <div class="stat-number">${stats.totalSignatures.toLocaleString()}</div>
                    <div class="stat-label">Signatures totales</div>
                    <div class="stat-growth ${growthClass}">
                        ${growthIcon} ${Math.abs(stats.growthPercent)}% vs hier
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-number">${stats.activeCollaborators}</div>
                    <div class="stat-label">Collaborateurs actifs</div>
                    <div class="stat-growth growth-positive">
                        üìà ${stats.activeToday} actifs aujourd'hui
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-number">${stats.avgQuality}%</div>
                    <div class="stat-label">Qualit√© moyenne</div>
                    <div class="stat-growth growth-positive">
                        ‚≠ê ${stats.avgConfidence}% confiance
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-number">${(stats.realInitiatives || []).length}</div>
                    <div class="stat-label">Initiatives actives</div>
                    <div class="stat-growth growth-positive">
                        üìã ${stats.totalScans} scans totaux
                    </div>
                </div>
            `;
        }

        function displayInitiativesPerformance(initiatives) {
            const container = document.getElementById('initiativesPerformance');
            
            if (initiatives.length === 0) {
                container.innerHTML = '<p>Aucune initiative trouv√©e</p>';
                return;
            }

            container.innerHTML = initiatives.map(init => {
                const progress = init.target > 0 ? Math.min((init.collected / init.target) * 100, 100) : 0;
                
                return `
                    <div class="initiative-card">
                        <div class="initiative-header">
                            <div class="initiative-name">${init.name}</div>
                            <div class="initiative-status status-${init.status}">${init.status}</div>
                        </div>
                        <p style="color: #666; margin-bottom: 15px;">${init.description || 'Aucune description'}</p>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span><strong>${init.collected.toLocaleString()}</strong> / ${init.target.toLocaleString()} signatures</span>
                            <span><strong>${progress.toFixed(1)}%</strong></span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 14px; color: #666;">
                            <span>üìä ${init.scanCount} scans</span>
                            <span>üìÖ √âch√©ance: ${init.deadline ? new Date(init.deadline).toLocaleDateString() : 'Non d√©finie'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Collaborateurs
        async function loadCollaborators() {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Erreur collaborateurs');
                const collaborators = await response.json();
                
                displayCollaborators(collaborators);
                
                // Mettre √† jour le filtre activit√©
                const activityFilter = document.getElementById('activityCollaboratorFilter');
                activityFilter.innerHTML = '<option value="all">Tous les collaborateurs</option>';
                collaborators.forEach(collab => {
                    activityFilter.innerHTML += `<option value="${collab.id}">${collab.name}</option>`;
                });
                
            } catch (error) {
                console.error('Erreur collaborateurs:', error);
            }
        }

        function displayCollaborators(collaborators) {
            const tbody = document.querySelector('#collaboratorsTable tbody');
            
            if (collaborators.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">Aucun collaborateur trouv√©</td></tr>';
                return;
            }

            tbody.innerHTML = collaborators.map(collab => `
                <tr>
                    <td><strong>${collab.name || 'Nom manquant'}</strong></td>
                    <td>${collab.email}</td>
                    <td>
                        ${collab.suspended ? 
                            '<span class="status-badge status-rejected">Suspendu</span>' : 
                            '<span class="status-badge status-approved">Actif</span>'
                        }
                    </td>
                    <td>${collab.scanCount || 0}</td>
                    <td>${(collab.signatures || 0).toLocaleString()}</td>
                    <td>${collab.avgQuality || 0}%</td>
                    <td>${collab.lastScan ? new Date(collab.lastScan).toLocaleDateString() : 'Jamais'}</td>
                    <td>
                        <button class="btn btn-primary" onclick="viewCollaboratorDetails(${collab.id})" style="margin-right: 5px;">Voir</button>
                        ${collab.suspended ? 
                            `<button class="btn btn-success" onclick="unsuspendCollaborator(${collab.id})">R√©activer</button>` :
                            `<button class="btn btn-warning" onclick="suspendCollaborator(${collab.id})">Suspendre</button>`
                        }
                    </td>
                </tr>
            `).join('');
        }

        async function viewCollaboratorDetails(id) {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/users/${id}/details`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Erreur d√©tails');
                const data = await response.json();
                const collab = data.collaborator;
                
                document.getElementById('collaboratorDetails').innerHTML = `
                    <div class="form-group">
                        <strong>Informations personnelles</strong>
                        <p>Nom: ${collab.first_name} ${collab.last_name}</p>
                        <p>Email: ${collab.email}</p>
                        <p>T√©l√©phone: ${collab.phone || 'Non renseign√©'}</p>
                        <p>Statut: ${collab.suspended ? 'Suspendu' : 'Actif'}</p>
                        ${collab.suspension_reason ? `<p>Raison suspension: ${collab.suspension_reason}</p>` : ''}
                    </div>
                    <div class="form-group">
                        <strong>Statistiques</strong>
                        <p>Total scans: ${collab.total_scans || 0}</p>
                        <p>Total signatures: ${collab.total_signatures || 0}</p>
                        <p>Qualit√© moyenne: ${Math.round(collab.avg_quality || 0)}%</p>
                        <p>Confiance moyenne: ${Math.round(collab.avg_confidence || 0)}%</p>
                        <p>Dernier scan: ${collab.last_scan_date ? new Date(collab.last_scan_date).toLocaleDateString() : 'Jamais'}</p>
                    </div>
                    ${collab.scansByInitiative && collab.scansByInitiative.length > 0 ? `
                        <div class="form-group">
                            <strong>Activit√© par initiative</strong>
                            ${collab.scansByInitiative.map(init => `
                                <p>${init.initiative}: ${init.scanCount} scans, ${init.totalSignatures} signatures</p>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
                
                showModal('collaboratorModal');
                
            } catch (error) {
                console.error('Erreur d√©tails collaborateur:', error);
            }
        }

        async function suspendCollaborator(id) {
            const reason = prompt('Raison de la suspension:');
            if (!reason) return;
            
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/users/${id}/suspend`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason })
                });
                
                if (!response.ok) throw new Error('Erreur suspension');
                
                alert('Collaborateur suspendu avec succ√®s');
                loadCollaborators();
                
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        }

        async function unsuspendCollaborator(id) {
            if (!confirm('Confirmer la r√©activation de ce collaborateur ?')) return;
            
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/users/${id}/unsuspend`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Erreur r√©activation');
                
                alert('Collaborateur r√©activ√© avec succ√®s');
                loadCollaborators();
                
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        }

        // Initiatives
        async function loadInitiatives() {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/admin/initiatives', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Erreur initiatives');
                const data = await response.json();
                
                displayInitiatives(data.initiatives);
                
                // Mettre √† jour le filtre activit√©
                const activityFilter = document.getElementById('activityInitiativeFilter');
                activityFilter.innerHTML = '<option value="all">Toutes les initiatives</option>';
                data.initiatives.forEach(init => {
                    activityFilter.innerHTML += `<option value="${init.name}">${init.name}</option>`;
                });
                
            } catch (error) {
                console.error('Erreur initiatives:', error);
            }
        }

        function displayInitiatives(initiatives) {
            const container = document.getElementById('initiativesList');
            
            if (initiatives.length === 0) {
                container.innerHTML = '<p>Aucune initiative trouv√©e</p>';
                return;
            }

            container.innerHTML = initiatives.map(init => {
                const progress = init.target > 0 ? Math.min((init.collected / init.target) * 100, 100) : 0;
                const statusClass = init.isActive ? 'status-active' : 'status-inactive';
                
                return `
                    <div class="initiative-card">
                        <div class="initiative-header">
                            <div class="initiative-name">${init.name}</div>
                            <div>
                                <span class="initiative-status ${statusClass}">
                                    ${init.isActive ? 'Actif' : 'Inactif'}
                                </span>
                                <button class="btn btn-primary" onclick="toggleInitiative(${init.id})" style="margin-left: 10px;">
                                    ${init.isActive ? 'D√©sactiver' : 'Activer'}
                                </button>
                            </div>
                        </div>
                        <p style="color: #666; margin-bottom: 15px;">${init.description || 'Aucune description'}</p>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span><strong>${init.collected.toLocaleString()}</strong> / ${init.target.toLocaleString()} signatures</span>
                            <span><strong>${progress.toFixed(1)}%</strong></span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 14px; color: #666;">
                            <span>üìä ${init.scanCount} scans</span>
                            <span>üë• ${init.collaboratorsCount} collaborateurs</span>
                            <span>üìÖ ${init.deadline ? new Date(init.deadline).toLocaleDateString() : 'Pas d\'√©ch√©ance'}</span>
                        </div>
                        ${init.images && init.images.length > 0 ? `
                            <div style="margin-top: 15px;">
                                <strong>Images de r√©f√©rence:</strong>
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    ${init.images.slice(0, 3).map(img => `
                                        <img src="${img.path}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                                    `).join('')}
                                    ${init.images.length > 3 ? `<span style="color: #666;">+${init.images.length - 3} autres</span>` : ''}
                                </div>
                            </div>
                        ` : ''}
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="uploadInitiativeImages(${init.id})">üì∑ Images</button>
                            <button class="btn btn-warning" onclick="editInitiative(${init.id})">‚úèÔ∏è Modifier</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function toggleInitiative(id) {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/initiatives/${id}/toggle`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Erreur toggle');
                
                loadInitiatives();
                
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        }

        function showCreateInitiativeModal() {
            showModal('createInitiativeModal');
        }

        document.getElementById('createInitiativeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('initiativeName').value,
                description: document.getElementById('initiativeDescription').value,
                target_signatures: parseInt(document.getElementById('initiativeTarget').value),
                deadline: document.getElementById('initiativeDeadline').value || null,
                gpt_instructions: document.getElementById('initiativeGptInstructions').value,
                theme_color: document.getElementById('initiativeThemeColor').value
            };
            
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/admin/initiatives', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) throw new Error('Erreur cr√©ation');
                
                closeModal('createInitiativeModal');
                document.getElementById('createInitiativeForm').reset();
                loadInitiatives();
                alert('Initiative cr√©√©e avec succ√®s');
                
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        });

        // V√©rifications
        async function loadPendingVerifications() {
            try {
                const token = localStorage.getItem('adminToken');
                const doubtReason = document.getElementById('doubtReasonFilter').value;
                
                const url = `/api/admin/verifications/pending?doubt_reason=${doubtReason}&limit=50`;
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Erreur v√©rifications');
                const data = await response.json();
                
                displayPendingVerifications(data.scans);
                
            } catch (error) {
                console.error('Erreur v√©rifications:', error);
            }
        }

        function displayPendingVerifications(scans) {
            const tbody = document.querySelector('#verificationsTable tbody');
            
            if (scans.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9">Aucune v√©rification en attente</td></tr>';
                return;
            }

            tbody.innerHTML = scans.map(scan => `
                <tr>
                    <td><input type="checkbox" class="verification-checkbox" data-scan-id="${scan.id}"></td>
                    <td>${scan.collaboratorName}</td>
                    <td>${scan.initiative}</td>
                    <td>${scan.signatures}</td>
                    <td><span class="status-badge status-pending">${scan.doubtDescription}</span></td>
                    <td>${scan.quality}%</td>
                    <td>${scan.confidence}%</td>
                    <td>${new Date(scan.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-success" onclick="approveVerification(${scan.id})" style="margin-right: 5px;">
                            ‚úÖ Approuver
                        </button>
                        <button class="btn btn-danger" onclick="rejectVerification(${scan.id})">
                            ‚ùå Rejeter
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function approveVerification(scanId) {
            const signatures = prompt('Nombre de signatures correct:');
            const initiative = prompt('Initiative correcte:');
            
            if (!signatures || !initiative) return;
            
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/verifications/${scanId}/verify`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        verified_signatures: parseInt(signatures),
                        verified_initiative: initiative,
                        verification_status: 'approved',
                        admin_notes: 'Approuv√© manuellement'
                    })
                });
                
                if (!response.ok) throw new Error('Erreur approbation');
                
                loadPendingVerifications();
                alert('Scan approuv√© avec succ√®s');
                
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        }

        async function rejectVerification(scanId) {
            const reason = prompt('Raison du rejet:');
            if (!reason) return;
            
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/verifications/${scanId}/verify`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        verification_status: 'rejected',
                        admin_notes: reason
                    })
                });
                
                if (!response.ok) throw new Error('Erreur rejet');
                
                loadPendingVerifications();
                alert('Scan rejet√© avec succ√®s');
                
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllVerifications');
            const checkboxes = document.querySelectorAll('.verification-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                if (selectAll.checked) {
                    selectedVerifications.add(checkbox.dataset.scanId);
                } else {
                    selectedVerifications.delete(checkbox.dataset.scanId);
                }
            });
        }

        // Activit√©
        async function loadActivityDetailed() {
            try {
                const token = localStorage.getItem('adminToken');
                const params = new URLSearchParams({
                    collaborator_id: document.getElementById('activityCollaboratorFilter').value,
                    initiative: document.getElementById('activityInitiativeFilter').value,
                    date_from: document.getElementById('activityDateFrom').value,
                    date_to: document.getElementById('activityDateTo').value,
                    group_by: document.getElementById('activityGroupBy').value,
                    limit: 100
                });
                
                const response = await fetch(`/api/admin/activity/detailed?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Erreur activit√©');
                const data = await response.json();
                
                displayActivityStats(data.totals);
                displayActivityTable(data.activity);
                
            } catch (error) {
                console.error('Erreur activit√©:', error);
            }
        }

        function displayActivityStats(totals) {
            const container = document.getElementById('activityStats');
            
            if (totals.length === 0) {
                container.innerHTML = '<div class="loading">Aucune donn√©e pour cette p√©riode</div>';
                return;
            }

            const totalSignatures = totals.reduce((sum, period) => sum + period.totalSignatures, 0);
            const totalScans = totals.reduce((sum, period) => sum + period.totalScans, 0);
            const avgQuality = totals.reduce((sum, period) => sum + period.avgQuality, 0) / totals.length;

            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">üìù</div>
                    <div class="stat-number">${totalSignatures.toLocaleString()}</div>
                    <div class="stat-label">Signatures p√©riode</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-number">${totalScans}</div>
                    <div class="stat-label">Scans p√©riode</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚≠ê</div>
                    <div class="stat-number">${Math.round(avgQuality)}%</div>
                    <div class="stat-label">Qualit√© moyenne</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-number">${totals.length}</div>
                    <div class="stat-label">P√©riodes actives</div>
                </div>
            `;
        }

        function displayActivityTable(activity) {
            const tbody = document.querySelector('#activityTable tbody');
            
            if (activity.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">Aucune activit√© trouv√©e</td></tr>';
                return;
            }

            tbody.innerHTML = activity.map(item => `
                <tr>
                    <td>${item.periodFormatted}</td>
                    <td>${item.collaboratorName}</td>
                    <td>${item.initiative}</td>
                    <td>${item.totalScans}</td>
                    <td>${item.totalSignatures.toLocaleString()}</td>
                    <td>${item.avgQuality}%</td>
                    <td>${item.reliability}%</td>
                </tr>
            `).join('');
        }

        // MATCHING SYSTEM FUNCTIONS

        // Navigation matching
        function switchMatchingTab(tabName) {
            // Masquer toutes les sections matching
            document.querySelectorAll('.matching-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // D√©sactiver tous les boutons subnav
            document.querySelectorAll('.subnav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activer la section s√©lectionn√©e
            document.getElementById(`matching-${tabName}`).classList.add('active');
            event.target.classList.add('active');
            
            // Charger les donn√©es sp√©cifiques
            switch(tabName) {
                case 'pending':
                    loadPendingMatches();
                    break;
                case 'dashboard':
                    loadMatchingDashboard();
                    break;
                case 'upload':
                    initializeUploadZone();
                    break;
            }
        }

        // Upload Zone Setup
        function initializeUploadZone() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');
            
            if (!uploadZone || !fileInput) return;
            
            // Remove existing listeners
            uploadZone.replaceWith(uploadZone.cloneNode(true));
            const newUploadZone = document.getElementById('uploadZone');
            
            // Drag and Drop
            newUploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                newUploadZone.classList.add('dragover');
            });
            
            newUploadZone.addEventListener('dragleave', () => {
                newUploadZone.classList.remove('dragover');
            });
            
            newUploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                newUploadZone.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleFileUpload(files);
            });
            
            // File Input
            const newFileInput = document.getElementById('fileInput');
            newFileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleFileUpload(files);
            });
        }

        function triggerFileInput() {
            document.getElementById('fileInput').click();
        }

        // File Upload Handler
        async function handleFileUpload(files) {
            if (files.length === 0) return;
            
            // Filtrer seulement les images
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            
            if (imageFiles.length === 0) {
                alert('Veuillez s√©lectionner des fichiers image uniquement');
                return;
            }
            
            if (imageFiles.length > 1000) {
                alert('Maximum 1000 fichiers autoris√©s');
                return;
            }
            
            // Pr√©parer l'upload
            const formData = new FormData();
            imageFiles.forEach(file => {
                formData.append('validation_files', file);
            });
            
            // Afficher la progression
            showUploadProgress(imageFiles.length);
            
            try {
                const response = await fetch('/api/matching/upload-batch', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: formData
                });
                
                if (!response.ok) throw new Error('Erreur upload');
                
                const result = await response.json();
                displayUploadResults(result);
                
            } catch (error) {
                console.error('Erreur upload:', error);
                alert('Erreur lors de l\'upload: ' + error.message);
                hideUploadProgress();
            }
        }

        function showUploadProgress(totalFiles) {
            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('uploadResults').style.display = 'none';
            
            // Simuler progression (en r√©alit√©, √ßa d√©pendrait du backend)
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                }
                
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressText').textContent = `${Math.floor(progress * totalFiles / 100)}/${totalFiles} fichiers trait√©s`;
                document.getElementById('progressPercent').textContent = Math.floor(progress) + '%';
            }, 200);
        }

        function hideUploadProgress() {
            document.getElementById('uploadProgress').style.display = 'none';
        }

        function displayUploadResults(result) {
            hideUploadProgress();
            
            const resultsDiv = document.getElementById('uploadResults');
            resultsDiv.style.display = 'block';
            
            // Mettre √† jour les statistiques
            document.getElementById('totalProcessed').textContent = result.results?.length || 0;
            document.getElementById('autoMatched').textContent = result.processed || 0;
            document.getElementById('pendingReview').textContent = result.errors || 0;
            document.getElementById('errorCount').textContent = result.errors || 0;
            
            // Afficher les d√©tails
            const detailsDiv = document.getElementById('resultsDetails');
            if (result.results && result.results.length > 0) {
                detailsDiv.innerHTML = `
                    <h5 style="color: white;">D√©tails Traitement</h5>
                    <div class="results-table">
                        ${result.results.slice(0, 10).map(item => `
                            <div class="result-row" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); color: white;">
                                <span class="filename">${item.filename}</span>
                                <span class="status ${item.status?.toLowerCase()}">${item.status}</span>
                                <span class="confidence">${item.confidence || 0}%</span>
                            </div>
                        `).join('')}
                        ${result.results.length > 10 ? `<div class="more-results" style="text-align: center; padding: 10px; color: rgba(255,255,255,0.7);">... et ${result.results.length - 10} autres</div>` : ''}
                    </div>
                `;
            }
        }

        // Pending Matches
        async function loadPendingMatches() {
            try {
                const response = await fetch('/api/matching/pending-matches', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });
                
                if (!response.ok) throw new Error('Erreur chargement matches');
                
                const data = await response.json();
                displayPendingMatches(data.pending_matches || []);
                
            } catch (error) {
                console.error('Erreur pending matches:', error);
                document.getElementById('pendingMatchesList').innerHTML =
                    '<div class="error">Erreur chargement des matches en attente</div>';
            }
        }

        function displayPendingMatches(matches) {
            const container = document.getElementById('pendingMatchesList');
            
            if (matches.length === 0) {
                container.innerHTML = '<div class="no-data">‚úÖ Aucun match en attente de validation</div>';
                return;
            }
            
            container.innerHTML = matches.map(match => `
                <div class="match-item">
                    <h4>Match en attente #${match.id}</h4>
                    <div class="match-info" style="margin-bottom: 15px;">
                        <strong>Validation:</strong> ${match.validation_data.collaborator} - ${match.validation_data.initiative} (${match.validation_data.signatures} signatures)
                    </div>
                    <div class="match-candidates">
                        ${match.candidates.map(candidate => `
                            <div class="candidate" onclick="selectCandidate(${match.id}, ${candidate.id})">
                                <strong>${candidate.collaborator}</strong><br>
                                Score: ${candidate.score}%<br>
                                <button class="btn btn-primary" style="margin-top: 10px;">Valider ce match</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function refreshPendingMatches() {
            loadPendingMatches();
        }

        function selectCandidate(matchId, candidateId) {
            // Logique de s√©lection du candidat
            alert(`Match ${matchId} avec candidat ${candidateId} s√©lectionn√©`);
        }

        // Matching Dashboard
        async function loadMatchingDashboard() {
            try {
                // Test API pour r√©cup√©rer stats
                const response = await fetch('/api/matching/test', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });
                
                if (!response.ok) throw new Error('Erreur stats');
                
                // Pour l'instant, stats simul√©es
                displayMatchingStats({
                    totalMatches: 1247,
                    autoSuccessRate: 87,
                    avgProcessTime: 2.3,
                    confidenceAvg: 92
                });
                
                createMatchingChart();
                loadRecentMatchingActivity();
                
            } catch (error) {
                console.error('Erreur dashboard matching:', error);
            }
        }

        function displayMatchingStats(stats) {
            document.getElementById('totalMatches').textContent = stats.totalMatches.toLocaleString();
            document.getElementById('autoSuccessRate').textContent = stats.autoSuccessRate + '%';
            document.getElementById('avgProcessTime').textContent = stats.avgProcessTime + 's';
            document.getElementById('confidenceAvg').textContent = stats.confidenceAvg + '%';
        }

        function createMatchingChart() {
            const ctx = document.getElementById('matchingChart').getContext('2d');
            
            if (matchingChart) {
                matchingChart.destroy();
            }
            
            matchingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin'],
                    datasets: [{
                        label: 'Matches Automatiques',
                        data: [65, 78, 90, 81, 87, 92],
                        borderColor: '#4ECDC4',
                        backgroundColor: 'rgba(78, 205, 196, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Matches Manuels',
                        data: [35, 22, 10, 19, 13, 8],
                        borderColor: '#FF6B6B',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function loadRecentMatchingActivity() {
            // Activit√© simul√©e pour l'instant
            const activities = [
                'Upload batch trait√©: 45 feuilles, 38 matches automatiques',
                'Match manuel valid√©: Jean Dupont ‚Üí Initiative For√™t',
                'Nouveau seuil de confiance configur√©: 90%',
                'Upload batch trait√©: 123 feuilles, 108 matches automatiques'
            ];
            
            document.getElementById('recentMatchingActivity').innerHTML =
                activities.map(activity => `<div class="activity-item">${activity}</div>`).join('');
        }

        // Configuration
        function saveMatchingConfig() {
            const config = {
                autoThreshold: document.getElementById('autoThreshold').value,
                manualThreshold: document.getElementById('manualThreshold').value,
                timeWindow: document.getElementById('timeWindow').value,
                signatureTolerance: document.getElementById('signatureTolerance').value
            };
            
            // Ici on sauvegarderait via API
            console.log('Configuration matching:', config);
            alert('Configuration sauvegard√©e avec succ√®s');
        }

        // Event listeners pour les sliders
        function setupMatchingEventListeners() {
            document.addEventListener('DOMContentLoaded', function() {
                const autoThreshold = document.getElementById('autoThreshold');
                const manualThreshold = document.getElementById('manualThreshold');
                
                if (autoThreshold) {
                    autoThreshold.addEventListener('input', function() {
                        document.getElementById('autoThresholdValue').textContent = this.value + '%';
                    });
                }
                
                if (manualThreshold) {
                    manualThreshold.addEventListener('input', function() {
                        document.getElementById('manualThresholdValue').textContent = this.value + '%';
                    });
                }
            });
        }

        // Navigation onglets MODIFI√âE pour inclure matching
        function switchTab(tabName) {
            // Masquer tous les onglets
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // D√©sactiver tous les boutons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activer l'onglet s√©lectionn√©
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Charger les donn√©es sp√©cifiques
            switch(tabName) {
                case 'collaborators':
                    loadCollaborators();
                    break;
                case 'initiatives':
                    loadInitiatives();
                    break;
                case 'verifications':
                    loadPendingVerifications();
                    break;
                case 'activity':
                    // Pas de chargement automatique, utilise les filtres
                    break;
                case 'matching':
                    // Charger par d√©faut l'upload
                    switchMatchingTab('upload');
                    break;
            }
        }

        // Modals
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Utilitaires
        function logout() {
            localStorage.removeItem('adminToken');
            window.location.reload();
        }

        // Initialisation des filtres activit√© avec dates par d√©faut
        window.addEventListener('load', function() {
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            
            const dateFromInput = document.getElementById('activityDateFrom');
            const dateToInput = document.getElementById('activityDateTo');
            
            if (dateFromInput && dateToInput) {
                dateFromInput.value = lastMonth.toISOString().split('T')[0];
                dateToInput.value = today.toISOString().split('T')[0];
            }
        });

        // Fonctions manquantes pour √©viter les erreurs
        function showCollaboratorStats() {
            alert('Fonctionnalit√© en d√©veloppement');
        }

        function loadVerificationStats() {
            alert('Fonctionnalit√© en d√©veloppement');
        }

        function bulkApprove() {
            alert('Fonctionnalit√© en d√©veloppement');
        }

        function bulkReject() {
            alert('Fonctionnalit√© en d√©veloppement');
        }

        function uploadInitiativeImages(id) {
            alert('Fonctionnalit√© en d√©veloppement - Initiative ID: ' + id);
        }

        function editInitiative(id) {
            alert('Fonctionnalit√© en d√©veloppement - Initiative ID: ' + id);
        }
    </script>
</body>
</html>
